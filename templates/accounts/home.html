<!-- templates/accounts/home.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Home - Civic Complaints System{% endblock %}

{% block extra_css %}
    <style>
        /* Chart Styles */
        .chart-section { background-color: #fff; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); margin-bottom: 2rem; }
        .chart-container { position: relative; height: 280px; width: 100%; max-width: 350px; margin: 0 auto; }
        .line-chart-container { position: relative; height: 320px; width: 100%; }
        .bar-chart-container { position: relative; height: 320px; width: 100%; }
        .no-chart-data { display: flex; align-items: center; justify-content: center; height: 100%; min-height: 150px; color: #6c757d; font-style: italic; text-align: center; background-color: #f8f9fa; border-radius: .25rem; padding: 1rem; }
        .chart-card { height: 100%; display: flex; flex-direction: column; }
        .chart-card .card-body { flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 0.75rem; }

        /* Heatmap Table Styles */
        .heatmap-table-container {
            /* Removed overflow and max-height to prevent internal scrolling */
            margin-top: 1rem;
        }
        .heatmap-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            table-layout: fixed; /* Keeps columns fixed width */
         }
        .heatmap-table th, .heatmap-table td {
            border: 1px solid #dee2e6;
            padding: 0.4rem 0.5rem;
            text-align: center;
            white-space: nowrap; /* Prevent text wrapping in cells */
        }
        .heatmap-table thead th {
            background-color: #f8f9fa;
            /* Sticky positioning removed as container no longer scrolls */
            font-weight: 600;
         }
        .heatmap-table tbody th {
            background-color: #f8f9fa;
            font-weight: 600;
            text-align: left;
            /* Sticky positioning removed as container no longer scrolls */
        }
        .heatmap-table td {
            background-color: #ffffff;
            transition: background-color 0.3s ease;
        }
        .heatmap-cell[data-count="0"] { background-color: #f8f9fa; color: #adb5bd;}
        /* Color scale */
        .heatmap-cell[data-count="1"] { background-color: #cfe2ff; }
        .heatmap-cell[data-count="2"] { background-color: #b7d4ff; }
        .heatmap-cell[data-count="3"] { background-color: #a0c5ff; }
        .heatmap-cell[data-count="4"] { background-color: #8ab7ff; }
        .heatmap-cell[data-count="5"] { background-color: #74a9ff; }
        .heatmap-cell[data-count-medium] { background-color: #5e9eff; } /* e.g., 6-10 */
        .heatmap-cell[data-count-high] { background-color: #3182f2; color: white;} /* e.g., 11-15 */
        .heatmap-cell[data-count-very-high] { background-color: #0b5ed7; color: white;} /* e.g., 16+ */

        /* Trend chart timeframe filter */
        .timeframe-filter { margin-bottom: 0.5rem; text-align: right;}
        /* Ensure active label style is obvious */
        .btn-check:checked + .btn-outline-secondary {
            color: #fff;
            background-color: #6c757d;
            border-color: #6c757d;
        }
    </style>
{% endblock %}


{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center mb-4">
        <div class="col-lg-10 col-md-12 text-center">
            <h1 class="mb-3">Welcome to the Civic Complaints System</h1>
             {# Renders conditional content based on login status/type #}
             {% include 'accounts/_home_content_conditional.html' %}
        </div>
    </div>

    {# --- START: User-Specific Statistics (Citizens) --- #}
    {% if user.is_authenticated and not is_official %}
        <hr class="my-5">
        <h2 class="text-center mb-4">Your Complaint Summary</h2>
        {# Row 1: User Doughnuts #}
        <div class="row mt-3 g-4 justify-content-center">
            <div class="col-lg-5 col-md-6">
                <div class="card chart-card shadow-sm">
                    <div class="card-header">Your Complaints by Type</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="userTypeChart"></canvas>
                            <div id="noUserTypeData" class="no-chart-data" style="display: none;">You haven't submitted any complaints yet.</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5 col-md-6">
                <div class="card chart-card shadow-sm">
                    <div class="card-header">Your Complaints by Status</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="userStatusChart"></canvas>
                            <div id="noUserStatusData" class="no-chart-data" style="display: none;">You haven't submitted any complaints yet.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {# Row 2: User Grouped Bar #}
         <div class="row mt-4 g-4 justify-content-center">
             <div class="col-lg-10 col-md-12">
                 <div class="card chart-card shadow-sm">
                     <div class="card-header">Your Complaints per Ward by Type</div>
                     <div class="card-body">
                         <div class="bar-chart-container">
                            <canvas id="userWardTypeGroupedBarChart"></canvas>
                            <div id="noUserWardTypeGroupedData" class="no-chart-data" style="display: none;">No complaint data for wards available.</div>
                         </div>
                     </div>
                 </div>
             </div>
        </div>
        {# Row 3: User ART Bar Chart #}
        <div class="row mt-4 g-4 justify-content-center">
             <div class="col-lg-10 col-md-12">
                 <div class="card chart-card shadow-sm">
                     <div class="card-header">Your Average Complaint Resolution Time per Ward (Days)</div>
                     <div class="card-body">
                         <div class="bar-chart-container">
                            <canvas id="userArtPerWardBarChart"></canvas>
                            <div id="noUserArtData" class="no-chart-data" style="display: none;">No resolved complaints with ward data available.</div>
                         </div>
                     </div>
                 </div>
             </div>
        </div>
    {% endif %}
    {# --- END: User-Specific Statistics --- #}

    {# --- START: Official Ward Statistics --- #}
    {% if user.is_authenticated and is_official %}
        <hr class="my-5">
        <h2 class="text-center mb-4">Ward {{ user.official_profile.ward_number }} Complaint Summary</h2>
        {# Row 1: Official Doughnuts #}
        <div class="row mt-3 g-4 justify-content-center">
            <div class="col-lg-5 col-md-6">
                <div class="card chart-card shadow-sm">
                    <div class="card-header">Complaints by Type in Your Ward</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="officialWardTypeChart"></canvas>
                            <div id="noOfficialWardTypeData" class="no-chart-data" style="display: none;">No complaints found for your ward.</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5 col-md-6">
                <div class="card chart-card shadow-sm">
                    <div class="card-header">Complaints by Status in Your Ward</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="officialWardStatusChart"></canvas>
                            <div id="noOfficialWardStatusData" class="no-chart-data" style="display: none;">No complaints found for your ward.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {# Other charts are removed for officials on this page as requested #}
    {% endif %}
    {# --- END: Official Ward Statistics --- #}


    {# --- START: Overall Statistics (Guests Only) --- #}
    {% if not user.is_authenticated %}
        <hr class="my-5">
        <h2 class="text-center mb-4">Overall Complaint Statistics</h2>

        {# Row 1: Overall Doughnut Charts #}
        <div class="row mt-3 g-4 justify-content-center">
            <div class="col-lg-5 col-md-6">
                <div class="card chart-card shadow-sm">
                    <div class="card-header">All Complaints by Type</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="overallTypeChart"></canvas>
                            <div id="noOverallTypeData" class="no-chart-data" style="display: none;">No overall complaint data available.</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5 col-md-6">
                <div class="card chart-card shadow-sm">
                    <div class="card-header">All Complaints by Status</div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="overallStatusChart"></canvas>
                            <div id="noOverallStatusData" class="no-chart-data" style="display: none;">No overall complaint data available.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Row 2: Overall Grouped Bar Chart #}
        <div class="row mt-4 g-4 justify-content-center">
             <div class="col-lg-10 col-md-12">
                 <div class="card chart-card shadow-sm">
                     <div class="card-header">Complaints per Ward by Type</div>
                     <div class="card-body">
                         <div class="bar-chart-container">
                            <canvas id="overallWardTypeGroupedBarChart"></canvas>
                            <div id="noOverallWardTypeGroupedData" class="no-chart-data" style="display: none;">No overall complaint data available.</div>
                         </div>
                     </div>
                 </div>
             </div>
        </div>

         {# Row 3: Overall Heatmap Table #}
         <div class="row mt-4 g-4 justify-content-center">
            <div class="col-lg-10 col-md-12">
                 <div class="card shadow-sm">
                    <div class="card-header">Complaints Heatmap (Ward vs Type)</div>
                    <div class="card-body">
                         <div id="heatmapContainer" class="heatmap-table-container">
                            {# Table will be generated by JS #}
                            <div id="noOverallHeatmapData" class="no-chart-data" style="display: none; min-height: 150px;">No overall complaint data available.</div>
                         </div>
                         {# Optional: Static legend #}
                         <div class="d-flex justify-content-center mt-2 small gap-2 flex-wrap">
                            <span class="badge" style="background-color: #f8f9fa; color: #adb5bd; border: 1px solid #dee2e6;">0</span>
                            <span class="badge" style="background-color: #cfe2ff;">1-5</span>
                            <span class="badge" style="background-color: #5e9eff;">6-10</span>
                            <span class="badge" style="background-color: #3182f2; color: white;">11-15</span>
                            <span class="badge" style="background-color: #0b5ed7; color: white;">16+</span>
                         </div>
                    </div>
                 </div>
             </div>
        </div>

         {# Row 4: Overall Resolution Trend Line Chart #}
         <div class="row mt-4 g-4 justify-content-center">
            <div class="col-lg-10 col-md-12">
                 <div class="card chart-card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap"> {# Added flex-wrap #}
                         <span class="me-3">Complaint Trend (Created vs Resolved)</span> {# Added margin #}
                         {# Timeframe Filter Dropdown #}
                         <div class="timeframe-filter btn-group btn-group-sm mt-2 mt-md-0"> {# Added top margin for smaller screens #}
                            <input type="radio" class="btn-check" name="trendTimeframe" id="trendWeek" value="week">
                            <label class="btn btn-outline-secondary" for="trendWeek">Week</label>

                            <input type="radio" class="btn-check" name="trendTimeframe" id="trendMonth" value="month" checked>
                            <label class="btn btn-outline-secondary active" for="trendMonth">Month</label>

                            <input type="radio" class="btn-check" name="trendTimeframe" id="trendYear" value="year">
                            <label class="btn btn-outline-secondary" for="trendYear">Year</label>
                        </div>
                    </div>
                    <div class="card-body">
                         <div class="line-chart-container">
                            <canvas id="overallResolutionTrendLineChart"></canvas>
                             <div id="noOverallResolutionData" class="no-chart-data" style="display: none;">No resolution data available for the period.</div>
                         </div>
                    </div>
                 </div>
             </div>
        </div>

        {# Row 5: Overall ART Bar Chart #}
        <div class="row mt-4 g-4 justify-content-center">
             <div class="col-lg-10 col-md-12">
                 <div class="card chart-card shadow-sm">
                     <div class="card-header">Overall Average Complaint Resolution Time per Ward (Days)</div>
                     <div class="card-body">
                         <div class="bar-chart-container">
                            <canvas id="overallArtPerWardBarChart"></canvas>
                            <div id="noOverallArtData" class="no-chart-data" style="display: none;">No overall resolved complaints with ward data available.</div>
                         </div>
                     </div>
                 </div>
             </div>
        </div>

    {% endif %}
    {# --- END: Overall Statistics --- #}

</div> {# End Main Container #}
{% endblock %}


{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script>
        // --- Chart Instances (Global Scope within this script) ---
        let userTypeChart, userStatusChart, userWardTypeGroupedBarChart, userArtPerWardBarChart;
        let officialWardTypeChart, officialWardStatusChart; // <-- New for officials
        let overallTypeChart, overallStatusChart, overallWardTypeGroupedBarChart, overallResolutionTrendLineChart, overallArtPerWardBarChart;

        // --- Pass Django context flags to JS ---
        const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
        const isOfficial = {{ is_official|yesno:"true,false" }};


        document.addEventListener("DOMContentLoaded", function() {

            // --- Common Chart Config ---
            const commonDoughnutOptions = {
                 responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { padding: 15, boxWidth: 12, font: { size: 11 } } }, tooltip: { callbacks: { label: function(context) { let label = context.label || ''; if (label) { label += ': '; } if (context.parsed !== null) { const total = context.chart.data.datasets[0].data.reduce((acc, value) => acc + value, 0); const value = context.parsed; const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%'; label += `${value} (${percentage})`; } return label; } } } } };
            const commonBarLineOptions = {
                 responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 15, boxWidth: 12 } }, tooltip: { mode: 'index', intersect: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } };
             const artBarOptions = {
                responsive: true, maintainAspectRatio: false, indexAxis: 'x', plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { return `Avg: ${context.parsed.y.toFixed(1)} days`; } } } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Average Days' } }, x: { title: {display: true, text: 'Ward Number'}}} };

            // Defined color palettes
            const userTypeColors = ['#8B4513', '#9db17c', '#a6a6a6', '#0dcaf0', '#6f42c1', '#fd7e14'];
            const userStatusColors = ['#B22222', '#1E90FF', '#2e7d5a']; // Pending, In Progress, Resolved
            const overallTypeColors = ['#8B4513', '#9db17c', '#a6a6a6', '#0dcaf0', '#6f42c1', '#fd7e14'];
            const overallStatusColors = ['#B22222', '#1E90FF', '#2e7d5a'];
            const barColors = ['#8B4513', '#9db17c', '#a6a6a6', '#0dcaf0', '#6f42c1', '#fd7e14'];
            const lineColors = { created: 'rgb(255, 99, 132)', resolved: 'rgb(75, 192, 192)' };
            const artBarColor = 'rgba(54, 162, 235, 0.6)';

             // Helper to show/hide no data message
             function toggleNoData(canvasId, msgId, hasData) {
                const canvas = canvasId ? document.getElementById(canvasId) : null; // Allow null canvasId
                const msgDiv = document.getElementById(msgId);
                if (msgDiv) { // Always check msgDiv
                    msgDiv.style.display = hasData ? 'none' : 'flex';
                }
                if (canvas) { // Only act on canvas if it exists
                    canvas.style.display = hasData ? 'block' : 'none';
                }
             }


            // --- Render Citizen Charts ---
            if (isAuthenticated && !isOfficial) {
                try {
                    const userData = JSON.parse('{{ user_data|escapejs }}');
                    console.log("User Data:", userData); // Debug: Check parsed data

                    // User Type Doughnut
                    const userTypeCtx = document.getElementById('userTypeChart');
                    const hasUserTypeData = userData?.type_chart?.values?.length > 0;
                    toggleNoData('userTypeChart', 'noUserTypeData', hasUserTypeData);
                    if (userTypeCtx && hasUserTypeData && !userTypeChart) { // Check if chart exists before creating
                       userTypeChart = new Chart(userTypeCtx, { type: 'doughnut', data: { labels: userData.type_chart.labels, datasets: [{ label: 'Your Complaints by Type', data: userData.type_chart.values, backgroundColor: userTypeColors, borderColor: '#fff', borderWidth: 2, hoverOffset: 8 }] }, options: commonDoughnutOptions });
                    }

                    // User Status Doughnut
                    const userStatusCtx = document.getElementById('userStatusChart');
                    const hasUserStatusData = userData?.status_chart?.values?.length > 0;
                    toggleNoData('userStatusChart', 'noUserStatusData', hasUserStatusData);
                    if (userStatusCtx && hasUserStatusData && !userStatusChart) {
                        userStatusChart = new Chart(userStatusCtx, { type: 'doughnut', data: { labels: userData.status_chart.labels, datasets: [{ label: 'Your Complaints by Status', data: userData.status_chart.values, backgroundColor: userStatusColors, borderColor: '#fff', borderWidth: 2, hoverOffset: 8 }] }, options: commonDoughnutOptions });
                    }

                    // User Grouped Bar (Ward vs Type)
                    const userGroupedBarCtx = document.getElementById('userWardTypeGroupedBarChart');
                    const hasUserGroupedBarData = userData?.ward_type_grouped_bar?.labels?.length > 0 && userData?.ward_type_grouped_bar?.datasets?.some(ds => ds.data.some(d => d > 0));
                    toggleNoData('userWardTypeGroupedBarChart', 'noUserWardTypeGroupedData', hasUserGroupedBarData);
                     if (userGroupedBarCtx && hasUserGroupedBarData && !userWardTypeGroupedBarChart) {
                         if (userData.ward_type_grouped_bar.datasets) { userData.ward_type_grouped_bar.datasets.forEach((dataset, index) => { dataset.backgroundColor = barColors[index % barColors.length]; }); }
                        userWardTypeGroupedBarChart = new Chart(userGroupedBarCtx, { type: 'bar', data: userData.ward_type_grouped_bar, options: { ...commonBarLineOptions, plugins: { ...commonBarLineOptions.plugins, title: { display: false } }, scales: { x: { stacked: false }, y: { stacked: false, beginAtZero: true, ticks:{ precision: 0} } } } });
                     }

                     // User ART per Ward Bar Chart
                    const userArtCtx = document.getElementById('userArtPerWardBarChart');
                    const hasUserArtData = userData?.art_per_ward?.values?.length > 0;
                    toggleNoData('userArtPerWardBarChart', 'noUserArtData', hasUserArtData);
                     if (userArtCtx && hasUserArtData && !userArtPerWardBarChart) {
                        userArtPerWardBarChart = new Chart(userArtCtx, { type: 'bar', data: { labels: userData.art_per_ward.labels, datasets: [{ label: 'Avg Resolution Time (Days)', data: userData.art_per_ward.values, backgroundColor: artBarColor }] }, options: artBarOptions });
                     }

                } catch (e) { console.error("Error rendering user charts:", e); }
            }
            // --- Render Official Ward Charts ---
            else if (isAuthenticated && isOfficial) {
                try {
                    const officialData = JSON.parse('{{ official_ward_data|escapejs }}');
                    console.log("Official Ward Data:", officialData);

                     // Official Ward Type Doughnut
                    const officialTypeCtx = document.getElementById('officialWardTypeChart');
                    const hasOfficialTypeData = officialData?.type_chart?.values?.length > 0;
                    toggleNoData('officialWardTypeChart', 'noOfficialWardTypeData', hasOfficialTypeData);
                    if (officialTypeCtx && hasOfficialTypeData && !officialWardTypeChart) {
                        officialWardTypeChart = new Chart(officialTypeCtx, { type: 'doughnut', data: { labels: officialData.type_chart.labels, datasets: [{ label: 'Complaints by Type in Ward', data: officialData.type_chart.values, backgroundColor: userTypeColors, borderColor: '#fff', borderWidth: 2, hoverOffset: 8 }] }, options: commonDoughnutOptions });
                    }

                    // Official Ward Status Doughnut
                    const officialStatusCtx = document.getElementById('officialWardStatusChart');
                    const hasOfficialStatusData = officialData?.status_chart?.values?.length > 0;
                    toggleNoData('officialWardStatusChart', 'noOfficialWardStatusData', hasOfficialStatusData);
                    if (officialStatusCtx && hasOfficialStatusData && !officialWardStatusChart) {
                        officialWardStatusChart = new Chart(officialStatusCtx, { type: 'doughnut', data: { labels: officialData.status_chart.labels, datasets: [{ label: 'Complaints by Status in Ward', data: officialData.status_chart.values, backgroundColor: userStatusColors, borderColor: '#fff', borderWidth: 2, hoverOffset: 8 }] }, options: commonDoughnutOptions });
                    }

                } catch (e) { console.error("Error rendering official ward charts:", e); }
            }
            // --- Render Overall Statistics Charts (Guests) ---
            else if (!isAuthenticated) {
                try {
                    const overallData = JSON.parse('{{ overall_data|escapejs }}');
                    console.log("Overall Data:", overallData); // Debug: Check parsed data

                    // Overall Type Doughnut
                    const overallTypeCtx = document.getElementById('overallTypeChart');
                    const hasOverallTypeData = overallData?.type_chart?.values?.length > 0;
                    toggleNoData('overallTypeChart', 'noOverallTypeData', hasOverallTypeData);
                    if (overallTypeCtx && hasOverallTypeData && !overallTypeChart) {
                        overallTypeChart = new Chart(overallTypeCtx, { type: 'doughnut', data: { labels: overallData.type_chart.labels, datasets: [{ label: 'All Complaints by Type', data: overallData.type_chart.values, backgroundColor: overallTypeColors, borderColor: '#fff', borderWidth: 2, hoverOffset: 8 }] }, options: commonDoughnutOptions });
                    }

                    // Overall Status Doughnut
                    const overallStatusCtx = document.getElementById('overallStatusChart');
                    const hasOverallStatusData = overallData?.status_chart?.values?.length > 0;
                    toggleNoData('overallStatusChart', 'noOverallStatusData', hasOverallStatusData);
                    if (overallStatusCtx && hasOverallStatusData && !overallStatusChart) {
                        overallStatusChart = new Chart(overallStatusCtx, { type: 'doughnut', data: { labels: overallData.status_chart.labels, datasets: [{ label: 'All Complaints by Status', data: overallData.status_chart.values, backgroundColor: overallStatusColors, borderColor: '#fff', borderWidth: 2, hoverOffset: 8 }] }, options: commonDoughnutOptions });
                    }

                    // Overall Grouped Bar (Ward vs Type)
                    const overallGroupedBarCtx = document.getElementById('overallWardTypeGroupedBarChart');
                    const hasOverallGroupedBarData = overallData?.ward_type_grouped_bar?.labels?.length > 0 && overallData?.ward_type_grouped_bar?.datasets?.some(ds => ds.data.some(d => d > 0));
                    toggleNoData('overallWardTypeGroupedBarChart', 'noOverallWardTypeGroupedData', hasOverallGroupedBarData);
                    if (overallGroupedBarCtx && hasOverallGroupedBarData && !overallWardTypeGroupedBarChart) {
                         if (overallData.ward_type_grouped_bar.datasets) { overallData.ward_type_grouped_bar.datasets.forEach((dataset, index) => { dataset.backgroundColor = barColors[index % barColors.length]; }); }
                        overallWardTypeGroupedBarChart = new Chart(overallGroupedBarCtx, { type: 'bar', data: overallData.ward_type_grouped_bar, options: { ...commonBarLineOptions, plugins: { ...commonBarLineOptions.plugins, title: { display: false } }, scales: { x: { stacked: false }, y: { stacked: false, beginAtZero: true, ticks:{ precision: 0} } } } });
                    }

                    // Overall Heatmap Table Generation
                    const heatmapContainer = document.getElementById('heatmapContainer');
                    const noHeatmapDataMsg = document.getElementById('noOverallHeatmapData');
                    const hasHeatmapData = overallData?.heatmap?.wards?.length > 0 && overallData?.heatmap?.types?.length > 0;
                    toggleNoData(null, 'noOverallHeatmapData', hasHeatmapData);
                    if (heatmapContainer && hasHeatmapData) {
                        heatmapContainer.innerHTML = ''; // Clear
                        const table = document.createElement('table'); table.className = 'table table-bordered table-sm heatmap-table';
                        const thead = table.createTHead(); const headerRow = thead.insertRow();
                        const thCorner = document.createElement('th'); thCorner.textContent = 'Ward'; headerRow.appendChild(thCorner);
                        overallData.heatmap.types.forEach(typeKey => { const th = document.createElement('th'); th.textContent = overallData.heatmap.type_names[typeKey] || typeKey.charAt(0).toUpperCase() + typeKey.slice(1); headerRow.appendChild(th); });
                        const tbody = table.createTBody();
                        overallData.heatmap.wards.forEach(ward => {
                            const row = tbody.insertRow();
                            const thWard = document.createElement('th'); thWard.textContent = ward; row.appendChild(thWard);
                            overallData.heatmap.types.forEach(typeKey => {
                                const cell = row.insertCell(); const count = overallData.heatmap.data[ward]?.[typeKey] || 0; cell.textContent = count; cell.classList.add('heatmap-cell'); cell.setAttribute('data-count', count);
                                if (count > 15) { cell.setAttribute('data-count-very-high', ''); } else if (count > 10) { cell.setAttribute('data-count-high', ''); } else if (count > 5) { cell.setAttribute('data-count-medium', ''); }
                            });
                        });
                        heatmapContainer.appendChild(table);
                    } else if(heatmapContainer) { heatmapContainer.innerHTML = ''; heatmapContainer.appendChild(noHeatmapDataMsg); }


                    // --- Overall Resolution Trend Line Chart (Initial Load & Update Logic) ---
                    const lineChartCtx = document.getElementById('overallResolutionTrendLineChart');
                    const initialTrendData = overallData?.resolution_trend;
                    const hasInitialTrendData = initialTrendData?.labels?.length > 0 && (initialTrendData.created_counts.some(c => c > 0) || initialTrendData.resolved_counts.some(r => r > 0));
                    toggleNoData('overallResolutionTrendLineChart', 'noOverallResolutionData', hasInitialTrendData);

                    function createOrUpdateTrendChart(chartData) {
                        const ctx = document.getElementById('overallResolutionTrendLineChart');
                        const hasData = chartData?.labels?.length > 0 && (chartData.created_counts.some(c => c > 0) || chartData.resolved_counts.some(r => r > 0));
                        toggleNoData('overallResolutionTrendLineChart', 'noOverallResolutionData', hasData);

                        if (!ctx) return; // Exit if canvas not found

                        if (hasData) {
                            if (overallResolutionTrendLineChart) { // Chart exists, update it
                                console.log("Updating trend chart with:", chartData);
                                overallResolutionTrendLineChart.data.labels = chartData.labels;
                                overallResolutionTrendLineChart.data.datasets[0].data = chartData.created_counts; // Created
                                overallResolutionTrendLineChart.data.datasets[1].data = chartData.resolved_counts; // Resolved
                                overallResolutionTrendLineChart.update();
                            } else { // Chart doesn't exist, create it
                                 console.log("Creating trend chart with:", chartData);
                                 overallResolutionTrendLineChart = new Chart(ctx, {
                                    type: 'line',
                                    data: {
                                        labels: chartData.labels,
                                        datasets: [
                                            { label: 'Created', data: chartData.created_counts, borderColor: lineColors.created, backgroundColor: lineColors.created.replace('rgb','rgba').replace(')',', 0.1)'), fill: 'origin', tension: 0.1, pointRadius: 2, pointHoverRadius: 4 },
                                            { label: 'Resolved', data: chartData.resolved_counts, borderColor: lineColors.resolved, backgroundColor: lineColors.resolved.replace('rgb','rgba').replace(')',', 0.1)'), fill: 'origin', tension: 0.1, pointRadius: 2, pointHoverRadius: 4 }
                                        ]
                                    },
                                    options: { ...commonBarLineOptions, scales: { ...commonBarLineOptions.scales, x: { ticks: { autoSkip: true, maxTicksLimit: 15 } } } }
                                });
                            }
                        } else {
                             // If no data, destroy chart if it exists to prevent issues
                             if (overallResolutionTrendLineChart) {
                                 overallResolutionTrendLineChart.destroy();
                                 overallResolutionTrendLineChart = null; // Reset instance variable
                             }
                        }
                    }

                    // Initial chart render
                    createOrUpdateTrendChart(initialTrendData);

                    // Event Listener for Trend Timeframe Filter
                    document.querySelectorAll('input[name="trendTimeframe"]').forEach(radio => {
                        radio.addEventListener('change', function() {
                            const selectedTimespan = this.value;
                            console.log("Fetching trend data for:", selectedTimespan); // Debug

                            // Update active label state
                            document.querySelectorAll('.timeframe-filter label').forEach(lbl => lbl.classList.remove('active'));
                            this.nextElementSibling.classList.add('active'); // Add active class to the label associated with the checked radio

                            fetch(`/accounts/api/overall-trend/?timespan=${selectedTimespan}`)
                                .then(response => {
                                    if (!response.ok) { throw new Error(`Network response was not ok: ${response.statusText}`); }
                                    return response.json();
                                })
                                .then(newData => {
                                    console.log("Received new trend data:", newData); // Debug
                                    createOrUpdateTrendChart(newData); // Use the helper function
                                })
                                .catch(error => {
                                    console.error('Error fetching trend data:', error);
                                    toggleNoData('overallResolutionTrendLineChart', 'noOverallResolutionData', false); // Show no data on error
                                    if (overallResolutionTrendLineChart) { // Destroy chart on error
                                         overallResolutionTrendLineChart.destroy();
                                         overallResolutionTrendLineChart = null;
                                     }
                                });
                        });
                    });
                    // --- End Trend Chart Logic ---


                    // Overall ART per Ward Bar Chart
                    const overallArtCtx = document.getElementById('overallArtPerWardBarChart');
                    const hasOverallArtData = overallData?.art_per_ward?.values?.length > 0;
                    toggleNoData('overallArtPerWardBarChart', 'noOverallArtData', hasOverallArtData);
                    if (overallArtCtx && hasOverallArtData && !overallArtPerWardBarChart) {
                        overallArtPerWardBarChart = new Chart(overallArtCtx, { type: 'bar', data: { labels: overallData.art_per_ward.labels, datasets: [{ label: 'Avg Resolution Time (Days)', data: overallData.art_per_ward.values, backgroundColor: artBarColor }] }, options: artBarOptions });
                    }

                } catch (e) { console.error("Error rendering overall charts:", e); }
            } // End guest stats

        }); // End DOMContentLoaded
    </script>
{% endblock %}